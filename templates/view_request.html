{% extends 'base.html' %}

{% block title %}{{ request.title }} - Request Details{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-4 animate-on-scroll">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">Request Details</li>
    </ol>
</nav>

<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4 animate-on-scroll">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h3 class="mb-0">{{ request.title }}</h3>
                <span class="badge 
                    {% if request.status == 'open' %}bg-success
                    {% elif request.status == 'assigned' %}bg-warning
                    {% else %}bg-secondary{% endif %}">
                    {{ request.status|capitalize }}
                </span>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-4">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                            <i class="fas fa-user fa-lg text-primary"></i>
                        </div>
                        <div>
                            <p class="mb-0 fw-bold">{{ request.owner.username }}</p>
                            <p class="text-muted small mb-0">Posted: {{ request.created_at.strftime('%B %d, %Y') }}</p>
                            {% if request.company_name %}
                            <p class="text-muted small mb-0"><i class="fas fa-building me-1"></i>{{ request.company_name }}</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-success bg-opacity-10 d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                            <i class="fas fa-dollar-sign fa-lg text-success"></i>
                        </div>
                        <div>
                            <p class="mb-0 fw-bold">${{ "%.2f"|format(request.budget) }}</p>
                            <p class="text-muted small mb-0">Budget</p>
                        </div>
                    </div>
                </div>
                
                <h5 class="mb-3">Description</h5>
                <div class="p-3 bg-light rounded mb-4 description-box">
                    {{ request.description|safe }}
                </div>
                
                {% if request.files %}
                <h5 class="mb-3">Attachments</h5>
                <div class="p-3 bg-light rounded mb-4">
                    <div class="row">
                        {% for file in request.files.split(',') %}
                            {% if file %}
                                {% set filename = file.split('/')[-1] if '/' in file else file.split('\\')[-1] if '\\' in file else file %}
                                {% set file_ext = filename.split('.')[-1].lower() %}
                                <div class="col-md-4 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body p-2 text-center">
                                            <div class="mb-2">
                                                {% if file_ext in ['jpg', 'jpeg', 'png', 'gif'] %}
                                                    <a href="{{ url_for('uploaded_file', filename=file) }}" target="_blank" class="d-block">
                                                        <img src="{{ url_for('uploaded_file', filename=file) }}" alt="{{ filename }}" class="img-fluid rounded" style="max-height: 120px;">
                                                    </a>
                                                {% elif file_ext == 'pdf' %}
                                                    <div class="document-icon mb-2">
                                                        <i class="fas fa-file-pdf fa-3x text-danger"></i>
                                                    </div>
                                                {% else %}
                                                    <div class="document-icon mb-2">
                                                        <i class="fas fa-file fa-3x text-secondary"></i>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <p class="small text-truncate mb-1">{{ filename }}</p>
                                            <a href="{{ url_for('uploaded_file', filename=file) }}" target="_blank" class="btn btn-sm btn-outline-primary w-100">
                                                <i class="fas fa-download me-1"></i>Download
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if offers|length > 0 and not is_owner and not has_made_offer %}
                    <div class="alert alert-info mt-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-comment-dollar me-2"></i>
                                This request has <strong>{{ offers|length }}</strong> offer(s).
                            </div>
                            {% if current_user.user_type == 'buyer' %}
                                <a href="{{ url_for('browse_offers', request_id=request.id) }}" class="btn btn-primary btn-pulse">
                                    <i class="fas fa-eye me-2"></i>View Offers
                                </a>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
                
                {% if is_owner %}
                    <div class="d-flex justify-content-end">
                        <a href="{{ url_for('edit_request', request_id=request.id) }}" class="btn btn-outline-primary me-2">
                            <i class="fas fa-edit me-2"></i>Edit Request
                        </a>
                        <button type="button" class="btn btn-outline-danger" id="delete-request-btn">
                            <i class="fas fa-trash-alt me-2"></i>Delete Request
                        </button>
                    </div>
                    
                    <!-- Delete confirmation modal -->
                    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p>Are you sure you want to delete this request?</p>
                                    <p class="text-danger"><strong>This action cannot be undone.</strong></p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <form action="{{ url_for('delete_request', request_id=request.id) }}" method="POST">
                                        <button type="submit" class="btn btn-danger">Delete</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
                
                {% if not is_owner and current_user.user_type == 'seller' %}
                    <div class="d-flex justify-content-end">
                        <a href="{{ url_for('make_offer', request_id=request.id) }}" class="btn btn-success">
                            <i class="fas fa-paper-plane me-2"></i>Make an Offer
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Offers Section -->
        {% if is_owner or has_made_offer %}
            <div class="card animate-on-scroll">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-comment-dollar me-2 text-primary"></i>Offers ({{ offers|length }})
                        </h4>
                        {% if offers|length > 0 and is_owner %}
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="sortOffersDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-sort me-1"></i>Sort By
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="sortOffersDropdown">
                                    <li><a class="dropdown-item sort-offers" href="#" data-sort="price-asc">Price (Low to High)</a></li>
                                    <li><a class="dropdown-item sort-offers" href="#" data-sort="price-desc">Price (High to Low)</a></li>
                                    <li><a class="dropdown-item sort-offers" href="#" data-sort="date-newest">Date (Newest First)</a></li>
                                    <li><a class="dropdown-item sort-offers" href="#" data-sort="date-oldest">Date (Oldest First)</a></li>
                                </ul>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body" id="offers-container">
                    {% if offers|length > 0 %}
                        {% for offer in offers %}
                            <div class="offer-card mb-3 animate-on-scroll" 
                                 style="animation-delay: {{ loop.index0 * 0.1 }}s"
                                 data-price="{{ offer.price }}"
                                 data-date="{{ offer.created_at.isoformat() }}">
                                <div class="card">
                                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                                <i class="fas fa-user fa-lg text-primary"></i>
                                            </div>
                                            <div>
                                                <p class="mb-0 fw-bold">{{ offer.seller.username }}</p>
                                                <p class="text-muted small mb-0">{{ offer.created_at.strftime('%B %d, %Y at %H:%M') }}</p>
                                            </div>
                                        </div>
                                        <div>
                                            <span class="badge {% if offer.status == 'pending' %}bg-warning
                                                {% elif offer.status == 'accepted' %}bg-success
                                                {% else %}bg-danger{% endif %}">
                                                {{ offer.status|capitalize }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="rounded-circle bg-success bg-opacity-10 d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                                <i class="fas fa-dollar-sign fa-lg text-success"></i>
                                            </div>
                                            <div>
                                                <h3 class="mb-0">${{ "%.2f"|format(offer.price) }}</h3>
                                                <p class="text-muted small mb-0">
                                                    {% if offer.price < request.budget %}
                                                        <span class="text-success"><i class="fas fa-arrow-down me-1"></i>${{ "%.2f"|format(request.budget - offer.price) }} under budget</span>
                                                    {% elif offer.price > request.budget %}
                                                        <span class="text-danger"><i class="fas fa-arrow-up me-1"></i>${{ "%.2f"|format(offer.price - request.budget) }} over budget</span>
                                                    {% else %}
                                                        <span class="text-muted">Matches budget exactly</span>
                                                    {% endif %}
                                                </p>
                                            </div>
                                        </div>
                                        
                                        <h5 class="mb-2">Offer Details</h5>
                                        <div class="p-3 bg-light rounded mb-3">
                                            {{ offer.description|safe }}
                                        </div>
                                        
                                        <!-- Added prominent view offer button -->
                                        <div class="text-center mb-4">
                                            <a href="{{ url_for('view_offer', offer_id=offer.id) }}" class="btn btn-primary btn-lg btn-pulse">
                                                <i class="fas fa-comment-dollar me-2"></i>View Complete Offer Details
                                            </a>
                                        </div>
                                        
                                        <div class="d-flex justify-content-between align-items-center mt-3">
                                            <a href="{{ url_for('view_offer', offer_id=offer.id) }}" class="btn btn-primary btn-lg btn-pulse">
                                                <i class="fas fa-eye me-2"></i>View Full Offer
                                            </a>
                                            
                                            {% if is_owner and offer.status == 'pending' %}
                                                <div>
                                                    <button class="btn btn-outline-danger me-2 reject-offer-btn" 
                                                            data-offer-id="{{ offer.id }}"
                                                            data-bs-toggle="modal" 
                                                            data-bs-target="#rejectModal">
                                                        <i class="fas fa-times me-2"></i>Decline
                                                    </button>
                                                    <button class="btn btn-success accept-offer-btn" 
                                                            data-offer-id="{{ offer.id }}"
                                                            data-bs-toggle="modal" 
                                                            data-bs-target="#acceptModal">
                                                        <i class="fas fa-check me-2"></i>Accept
                                                    </button>
                                                </div>
                                            {% endif %}
                                            
                                            {% if offer.seller_id == current_user.id and offer.status == 'pending' %}
                                                <div>
                                                    <button class="btn btn-outline-danger withdraw-offer-btn" 
                                                            data-offer-id="{{ offer.id }}"
                                                            data-bs-toggle="modal" 
                                                            data-bs-target="#withdrawModal">
                                                        <i class="fas fa-undo me-2"></i>Withdraw Offer
                                                    </button>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>There are no offers for this request yet.
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
    
    <div class="col-lg-4">
        <div class="card mb-4 animate-on-scroll">
            <div class="card-header bg-white">
                <h4 class="mb-0">
                    <i class="fas fa-info-circle me-2 text-primary"></i>Status Summary
                </h4>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-around text-center my-3">
                    <div>
                        <div class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 60px; height: 60px;">
                            <i class="fas fa-calendar-alt fa-lg text-primary"></i>
                        </div>
                        <p class="text-muted small">Posted</p>
                        <h6 class="fw-bold">{{ request.created_at.strftime('%m/%d/%Y') }}</h6>
                    </div>
                    <div>
                        <div class="rounded-circle bg-success bg-opacity-10 d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 60px; height: 60px;">
                            <i class="fas fa-comment-dollar fa-lg text-success"></i>
                        </div>
                        <p class="text-muted small">Offers</p>
                        <h6 class="fw-bold">{{ offers|length }}</h6>
                        {% if offers|length > 0 %}
                            <a href="{{ url_for('browse_offers', request_id=request.id) }}" class="btn btn-sm btn-primary mt-2">
                                <i class="fas fa-eye me-1"></i>View
                            </a>
                        {% endif %}
                    </div>
                    <div>
                        <div class="rounded-circle bg-warning bg-opacity-10 d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 60px; height: 60px;">
                            <i class="fas fa-clock fa-lg text-warning"></i>
                        </div>
                        <p class="text-muted small">Status</p>
                        <h6 class="fw-bold">{{ request.status|capitalize }}</h6>
                    </div>
                </div>
            </div>
        </div>
        
        {% if is_owner %}
            <div class="card animate-on-scroll">
                <div class="card-header bg-white">
                    <h4 class="mb-0">
                        <i class="fas fa-lightbulb me-2 text-primary"></i>Tips for Selecting an Offer
                    </h4>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-3 d-flex">
                            <i class="fas fa-check-circle text-success mt-1 me-3"></i>
                            <span>Review all offers carefully before making a decision</span>
                        </li>
                        <li class="mb-3 d-flex">
                            <i class="fas fa-check-circle text-success mt-1 me-3"></i>
                            <span>Compare prices and what's included in each offer</span>
                        </li>
                        <li class="mb-3 d-flex">
                            <i class="fas fa-check-circle text-success mt-1 me-3"></i>
                            <span>Look for sellers with clear communication</span>
                        </li>
                        <li class="mb-3 d-flex">
                            <i class="fas fa-check-circle text-success mt-1 me-3"></i>
                            <span>Cheaper isn't always better - consider value</span>
                        </li>
                        <li class="d-flex">
                            <i class="fas fa-check-circle text-success mt-1 me-3"></i>
                            <span>Once you accept an offer, others will be automatically declined</span>
                        </li>
                    </ul>
                </div>
            </div>
        {% else %}
            <div class="card animate-on-scroll">
                <div class="card-header bg-white">
                    <h4 class="mb-0">
                        <i class="fas fa-lightbulb me-2 text-primary"></i>Offer Tips
                    </h4>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-3 d-flex">
                            <i class="fas fa-check-circle text-success mt-1 me-3"></i>
                            <span>Be clear about what's included in your price</span>
                        </li>
                        <li class="mb-3 d-flex">
                            <i class="fas fa-check-circle text-success mt-1 me-3"></i>
                            <span>Highlight your relevant experience and expertise</span>
                        </li>
                        <li class="mb-3 d-flex">
                            <i class="fas fa-check-circle text-success mt-1 me-3"></i>
                            <span>Explain your approach to completing the project</span>
                        </li>
                        <li class="mb-3 d-flex">
                            <i class="fas fa-check-circle text-success mt-1 me-3"></i>
                            <span>Set realistic expectations for timeline and deliverables</span>
                        </li>
                        <li class="d-flex">
                            <i class="fas fa-check-circle text-success mt-1 me-3"></i>
                            <span>Stand out by showing you understand the buyer's needs</span>
                        </li>
                    </ul>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Accept Modal -->
<div class="modal fade" id="acceptModal" tabindex="-1" aria-labelledby="acceptModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="acceptModalLabel">Accept Offer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to accept this offer?</p>
                <p class="text-warning"><strong>This will automatically decline all other offers.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="" method="POST" id="accept-offer-form">
                    <input type="hidden" name="action" value="accept">
                    <button type="submit" class="btn btn-success" id="confirm-accept-btn">
                        <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                        Accept Offer
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rejectModalLabel">Decline Offer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to decline this offer?</p>
                <p class="text-danger"><strong>This action cannot be undone.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="" method="POST" id="reject-offer-form">
                    <input type="hidden" name="action" value="reject">
                    <button type="submit" class="btn btn-danger" id="confirm-reject-btn">
                        <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                        Decline Offer
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Withdraw Modal -->
<div class="modal fade" id="withdrawModal" tabindex="-1" aria-labelledby="withdrawModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="withdrawModalLabel">Withdraw Offer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to withdraw your offer?</p>
                <p class="text-danger"><strong>This action cannot be undone.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="" method="POST" id="withdraw-offer-form">
                    <input type="hidden" name="action" value="withdraw">
                    <button type="submit" class="btn btn-danger" id="confirm-withdraw-btn">
                        <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                        Withdraw Offer
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Delete request button
        const deleteBtn = document.getElementById('delete-request-btn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function() {
                const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
                deleteModal.show();
            });
        }
        
        // Set up offer action buttons
        const acceptBtns = document.querySelectorAll('.accept-offer-btn');
        const rejectBtns = document.querySelectorAll('.reject-offer-btn');
        const withdrawBtns = document.querySelectorAll('.withdraw-offer-btn');
        
        acceptBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const offerId = this.getAttribute('data-offer-id');
                const acceptForm = document.getElementById('accept-offer-form');
                acceptForm.action = `/offers/${offerId}/update`;
                
                document.getElementById('confirm-accept-btn').addEventListener('click', function() {
                    const spinner = this.querySelector('.spinner-border');
                    spinner.classList.remove('d-none');
                    this.disabled = true;
                });
            });
        });
        
        rejectBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const offerId = this.getAttribute('data-offer-id');
                const rejectForm = document.getElementById('reject-offer-form');
                rejectForm.action = `/offers/${offerId}/update`;
                
                document.getElementById('confirm-reject-btn').addEventListener('click', function() {
                    const spinner = this.querySelector('.spinner-border');
                    spinner.classList.remove('d-none');
                    this.disabled = true;
                });
            });
        });
        
        withdrawBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const offerId = this.getAttribute('data-offer-id');
                const withdrawForm = document.getElementById('withdraw-offer-form');
                withdrawForm.action = `/offers/${offerId}/update`;
                
                document.getElementById('confirm-withdraw-btn').addEventListener('click', function() {
                    const spinner = this.querySelector('.spinner-border');
                    spinner.classList.remove('d-none');
                    this.disabled = true;
                });
            });
        });
        
        // Handle sorting offers
        const sortOfferLinks = document.querySelectorAll('.sort-offers');
        sortOfferLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const sortBy = this.getAttribute('data-sort');
                const offersContainer = document.getElementById('offers-container');
                const offerCards = Array.from(document.querySelectorAll('.offer-card'));
                
                if (sortBy === 'price-asc') {
                    offerCards.sort((a, b) => parseFloat(a.dataset.price) - parseFloat(b.dataset.price));
                } else if (sortBy === 'price-desc') {
                    offerCards.sort((a, b) => parseFloat(b.dataset.price) - parseFloat(a.dataset.price));
                } else if (sortBy === 'date-newest') {
                    offerCards.sort((a, b) => new Date(b.dataset.date) - new Date(a.dataset.date));
                } else if (sortBy === 'date-oldest') {
                    offerCards.sort((a, b) => new Date(a.dataset.date) - new Date(a.dataset.date));
                }
                
                offerCards.forEach(card => {
                    offersContainer.appendChild(card);
                });
                
                // Show notification
                showNotification('Offers sorted successfully', 'success');
            });
        });
        
        // Add hover effects to the description box
        const descriptionBox = document.querySelector('.description-box');
        if (descriptionBox) {
            descriptionBox.addEventListener('mouseenter', function() {
                this.classList.add('description-highlight');
            });
            
            descriptionBox.addEventListener('mouseleave', function() {
                this.classList.remove('description-highlight');
            });
        }
        
        // NEW: Text highlighter for description
        const description = document.querySelector('.description-box');
        if (description) {
            // Create highlight button
            const highlightControls = document.createElement('div');
            highlightControls.className = 'highlight-controls mt-2 mb-3';
            highlightControls.innerHTML = `
                <div class="d-flex align-items-center">
                    <span class="me-2"><i class="fas fa-highlighter"></i> Highlight:</span>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary highlight-btn" data-color="yellow">Important</button>
                        <button class="btn btn-outline-success highlight-btn" data-color="green">Positive</button>
                        <button class="btn btn-outline-danger highlight-btn" data-color="red">Concerns</button>
                        <button class="btn btn-outline-secondary highlight-btn" data-color="clear">Clear</button>
                    </div>
                </div>
            `;
            
            // Insert highlight controls before description box
            description.parentNode.insertBefore(highlightControls, description);
            
            // Add event listeners for highlighting
            let activeHighlightBtn = null;
            let isHighlighting = false;
            const highlightBtns = document.querySelectorAll('.highlight-btn');
            
            highlightBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const color = this.getAttribute('data-color');
                    
                    // Clear previous active button
                    if (activeHighlightBtn) {
                        activeHighlightBtn.classList.remove('active');
                    }
                    
                    if (color === 'clear') {
                        // Clear all highlights
                        const highlights = description.querySelectorAll('mark');
                        highlights.forEach(h => {
                            const textNode = document.createTextNode(h.textContent);
                            h.parentNode.replaceChild(textNode, h);
                        });
                        
                        // Normalize the text (combine adjacent text nodes)
                        description.normalize();
                        isHighlighting = false;
                        showNotification('All highlights cleared', 'info');
                    } else {
                        // Set new active button
                        this.classList.add('active');
                        activeHighlightBtn = this;
                        isHighlighting = true;
                        
                        // Show instructions
                        showNotification('Select text in the description to highlight it', 'info');
                    }
                });
            });
            
            // Handle text selection and highlighting
            description.addEventListener('mouseup', function() {
                if (!isHighlighting || !activeHighlightBtn) return;
                
                const selection = window.getSelection();
                if (selection.toString().length > 0) {
                    const range = selection.getRangeAt(0);
                    const color = activeHighlightBtn.getAttribute('data-color');
                    
                    // Create highlight element
                    const highlight = document.createElement('mark');
                    highlight.className = `highlight-${color}`;
                    
                    // Apply highlight
                    range.surroundContents(highlight);
                    selection.removeAllRanges();
                }
            });
        }
        
        // NEW: Add offer comparison feature
        const offerCards = document.querySelectorAll('.offer-card');
        if (offerCards.length > 1) {
            // Create comparison button
            const comparisonContainer = document.createElement('div');
            comparisonContainer.className = 'text-center mb-4';
            comparisonContainer.innerHTML = `
                <button id="compare-offers-btn" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-balance-scale me-2"></i>Compare Selected Offers
                </button>
                <div id="comparison-instructions" class="small text-muted mt-2 d-none">
                    Select up to 3 offers to compare by clicking the checkbox in the top-right corner of each offer card.
                </div>
            `;
            
            // Add comparison button above offers
            const offersHeader = document.querySelector('.card-header:has(h4:contains("Offers"))');
            if (offersHeader) {
                const offersContainer = offersHeader.closest('.card');
                offersContainer.parentNode.insertBefore(comparisonContainer, offersContainer);
            }
            
            // Add checkboxes to offer cards for selection
            offerCards.forEach(card => {
                const cardHeader = card.querySelector('.card-header');
                if (cardHeader) {
                    const checkbox = document.createElement('div');
                    checkbox.className = 'form-check position-absolute top-0 end-0 mt-2 me-2 comparison-checkbox';
                    checkbox.innerHTML = `
                        <input class="form-check-input" type="checkbox" value="${card.dataset.price}" />
                    `;
                    cardHeader.style.position = 'relative';
                    cardHeader.appendChild(checkbox);
                }
            });
            
            // Initially hide checkboxes
            document.querySelectorAll('.comparison-checkbox').forEach(cb => {
                cb.style.display = 'none';
            });
            
            // Toggle comparison mode
            const compareBtn = document.getElementById('compare-offers-btn');
            const instructions = document.getElementById('comparison-instructions');
            let comparisonMode = false;
            
            compareBtn.addEventListener('click', function() {
                comparisonMode = !comparisonMode;
                
                if (comparisonMode) {
                    // Enable comparison mode
                    this.classList.replace('btn-outline-primary', 'btn-primary');
                    this.innerHTML = '<i class="fas fa-table me-2"></i>View Comparison Table';
                    instructions.classList.remove('d-none');
                    
                    // Show checkboxes
                    document.querySelectorAll('.comparison-checkbox').forEach(cb => {
                        cb.style.display = 'block';
                    });
                } else {
                    // Check if we have selected offers to compare
                    const selectedCheckboxes = document.querySelectorAll('.comparison-checkbox input:checked');
                    
                    if (selectedCheckboxes.length > 1) {
                        // Collect data for comparison
                        const offerData = [];
                        selectedCheckboxes.forEach(cb => {
                            const offerCard = cb.closest('.offer-card');
                            const sellerName = offerCard.querySelector('.fw-bold').textContent;
                            const price = parseFloat(offerCard.dataset.price);
                            const date = new Date(offerCard.dataset.date).toLocaleDateString();
                            const message = offerCard.querySelector('.bg-light.rounded').textContent.trim();
                            
                            offerData.push({ sellerName, price, date, message });
                        });
                        
                        // Create and show comparison modal
                        createComparisonModal(offerData);
                    } else {
                        // Reset to normal mode
                        this.classList.replace('btn-primary', 'btn-outline-primary');
                        this.innerHTML = '<i class="fas fa-balance-scale me-2"></i>Compare Selected Offers';
                        instructions.classList.add('d-none');
                        
                        // Hide checkboxes
                        document.querySelectorAll('.comparison-checkbox').forEach(cb => {
                            cb.style.display = 'none';
                            cb.querySelector('input').checked = false;
                        });
                        
                        showNotification('Please select at least 2 offers to compare', 'warning');
                    }
                }
            });
            
            function createComparisonModal(offerData) {
                // Create modal for comparison
                const modalDiv = document.createElement('div');
                modalDiv.className = 'modal fade';
                modalDiv.id = 'comparisonModal';
                modalDiv.setAttribute('tabindex', '-1');
                modalDiv.setAttribute('aria-labelledby', 'comparisonModalLabel');
                modalDiv.setAttribute('aria-hidden', 'true');
                
                let tableHeaders = '';
                offerData.forEach(offer => {
                    tableHeaders += `<th>${offer.sellerName}</th>`;
                });
                
                let priceRow = '';
                offerData.forEach(offer => {
                    priceRow += `<td>$${offer.price.toFixed(2)}</td>`;
                });
                
                let dateRow = '';
                offerData.forEach(offer => {
                    dateRow += `<td>${offer.date}</td>`;
                });
                
                let messageRow = '';
                offerData.forEach(offer => {
                    // Truncate message for the table
                    const truncatedMessage = offer.message.length > 100 
                        ? offer.message.substring(0, 100) + '...' 
                        : offer.message;
                    messageRow += `<td>${truncatedMessage}</td>`;
                });
                
                modalDiv.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="comparisonModalLabel">Offer Comparison</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            ${tableHeaders}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <th>Price</th>
                                            ${priceRow}
                                        </tr>
                                        <tr>
                                            <th>Date</th>
                                            ${dateRow}
                                        </tr>
                                        <tr>
                                            <th>Details</th>
                                            ${messageRow}
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Append modal to body
                document.body.appendChild(modalDiv);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('comparisonModal'));
                modal.show();
                
                // Clean up comparison mode
                compareBtn.classList.replace('btn-primary', 'btn-outline-primary');
                compareBtn.innerHTML = '<i class="fas fa-balance-scale me-2"></i>Compare Selected Offers';
                instructions.classList.add('d-none');
                
                // Hide checkboxes
                document.querySelectorAll('.comparison-checkbox').forEach(cb => {
                    cb.style.display = 'none';
                    cb.querySelector('input').checked = false;
                });
                
                // Remove modal after it's hidden
                modalDiv.addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(modalDiv);
                });
            }
        }
        
        // NEW: Animated budget visualization
        const budget = parseFloat('{{ request.budget }}');
        const offerPrices = document.querySelectorAll('.offer-card');
        
        if (budget && offerPrices.length > 0) {
            offerPrices.forEach(offer => {
                const priceContainer = offer.querySelector('h3.mb-0').parentNode;
                const price = parseFloat(offer.dataset.price);
                
                // Create budget visualization bar
                const visualBar = document.createElement('div');
                visualBar.className = 'budget-visual mt-2';
                visualBar.innerHTML = `
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar ${price <= budget ? 'bg-success' : 'bg-danger'}" 
                             role="progressbar" 
                             style="width: ${Math.min((price / (budget * 1.5)) * 100, 100)}%;"
                             aria-valuenow="${price}"
                             aria-valuemin="0" 
                             aria-valuemax="${budget * 1.5}">
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <small class="text-muted">$0</small>
                        <small class="text-muted">Budget: $${budget.toFixed(2)}</small>
                        <small class="text-muted">$${(budget * 1.5).toFixed(2)}</small>
                    </div>
                `;
                
                priceContainer.appendChild(visualBar);
                
                // Add animation on hover
                offer.addEventListener('mouseenter', function() {
                    const progressBar = this.querySelector('.progress-bar');
                    progressBar.style.transition = 'width 0.5s ease-in-out';
                    
                    // Pulse animation for the progress bar
                    let isExpanded = false;
                    const originalWidth = progressBar.style.width;
                    
                    const pulseInterval = setInterval(() => {
                        if (isExpanded) {
                            progressBar.style.width = originalWidth;
                        } else {
                            const currentWidth = parseFloat(originalWidth);
                            const newWidth = Math.min(currentWidth + 5, 100) + '%';
                            progressBar.style.width = newWidth;
                        }
                        isExpanded = !isExpanded;
                    }, 500);
                    
                    offer.addEventListener('mouseleave', function() {
                        clearInterval(pulseInterval);
                        progressBar.style.width = originalWidth;
                    }, { once: true });
                });
            });
        }
        
        // NEW: Animated entrance for the page elements
        function animateElements() {
            const elements = document.querySelectorAll('.animate-on-scroll');
            
            elements.forEach((element, index) => {
                // Add a slight delay based on the element's position
                const delay = index * 100;
                
                setTimeout(() => {
                    element.classList.add('animated-element');
                }, delay);
            });
        }
        
        // Trigger animations on page load
        animateElements();
        
        // NEW: Show welcome notification with tip
        setTimeout(() => {
            const isOwner = {{ 'true' if is_owner else 'false' }};
            if (isOwner) {
                showNotification('Tip: You can compare offers by clicking the "Compare Selected Offers" button.', 'info');
            } else {
                showNotification('Tip: Hover over the description to highlight important parts.', 'info');
            }
        }, 1000);
        
        // Highlight view offer buttons
        setTimeout(() => {
            const viewOfferButtons = document.querySelectorAll('.btn-pulse');
            viewOfferButtons.forEach(button => {
                button.classList.add('highlight-glow');
                setTimeout(() => {
                    button.classList.remove('highlight-glow');
                }, 3000);
            });
        }, 1000);
    });
</script>

<style>
    /* Animation styles */
    .animated-element {
        animation: fadeInUp 0.5s ease-out forwards;
    }
    
    @keyframes fadeInUp {
        0% {
            opacity: 0;
            transform: translateY(20px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Description highlight styles */
    .description-highlight {
        box-shadow: 0 0 15px rgba(0, 123, 255, 0.3);
        transition: all 0.3s ease;
    }
    
    .highlight-yellow {
        background-color: rgba(255, 230, 0, 0.5);
        padding: 0 2px;
    }
    
    .highlight-green {
        background-color: rgba(40, 167, 69, 0.3);
        padding: 0 2px;
    }
    
    .highlight-red {
        background-color: rgba(220, 53, 69, 0.3);
        padding: 0 2px;
    }
    
    /* Pulse animation for important buttons */
    .btn-pulse {
        animation: pulse-animation 2s infinite;
        box-shadow: 0 0 0 rgba(66, 133, 244, 0.4);
    }
    
    @keyframes pulse-animation {
        0% {
            box-shadow: 0 0 0 0 rgba(66, 133, 244, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(66, 133, 244, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(66, 133, 244, 0);
        }
    }
    
    /* Budget visual styles */
    .budget-visual {
        transition: all 0.3s ease;
    }
    
    .budget-visual:hover {
        transform: scale(1.05);
    }
    
    /* Comparison checkbox styles */
    .comparison-checkbox {
        z-index: 10;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        padding: 5px;
        transition: all 0.3s ease;
    }
    
    /* Additional highlight for buttons */
    .highlight-glow {
        transform: scale(1.05);
        background-color: #0d6efd;
        border-color: #0a58ca;
        box-shadow: 0 0 15px rgba(13, 110, 253, 0.7);
        transition: all 0.3s ease;
    }
</style>
{% endblock %} 